<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>分配用户</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <!--插件样式-->
    <link rel="stylesheet" href="../../plugins/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../plugins/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../plugins/datatables/css/mydatatable.css">
    <link rel="stylesheet" href="../../plugins/ztree/css/metroStyle/metroStyle.css">

    <!--自定义样式-->
    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="../../css/dictionaries.css">
</head>
<body>
<div id="assignRole" class="row wrapper wrapper-content">
    <div class="col-sm-4" style="border-right: 1px solid #A8A8A8;">
        <p>所在部门：</p>
        <input type="text" hidden="hidden" name="deptId" value id="dept">
        <div id="officeTree" class="ztree"></div>
    </div>
    <div class="col-sm-4">
        <p>待选人员：</p>
        <div id="userTree" class="ztree"></div>
    </div>
    <div class="col-sm-4" style="padding-left:16px;border-left: 1px solid #A8A8A8;">
        <p>已选人员：</p>
        <div id="selectedTree" class="ztree"></div>
    </div>
</div>
    <!--核心插件-->
    <script src="../../js/jquery-2.2.4.min.js"></script>
    <script src="../../plugins/bootstrap/js/bootstrap.min.js"></script>
    <!--附属插件-->
    <script src="../../plugins/layer/layer.js"></script>
    <script src="../../plugins/datatables/js/jquery.dataTables.min.js"></script>
    <script src="../../plugins/ztree/js/jquery.ztree.core.min.js"></script>
    <script src="../../plugins/ztree/js/jquery.ztree.excheck.js"></script>
    <script src="../../plugins/datatables/js/jquery.dataTables.min.js"></script>
    <!--自定义文件-->
    <script src="../../js/common.js"></script>
    <script src="../../js/customForm.js"></script>
    <script>
        var officeTree,selectedTree,pre_selectedNodes;//分别为 所有部门、zTree已选择对象、zTree未选择对象
        var id = getQueryString('id');
        var pre_ids = [], ids = [];
        var allDepUrl = "/api/sys/SysOrg/leftTree", //全部部门
            // unallotUrl = "/api/sys/SysUser/selectUser", //待选
            allotUrl = "/api/sys/SysOrg/assign/"+id;  //已选
        ajaxToServer(allDepUrl, {}, function (result) {
            if (result.success) {
                officeTree = $.fn.zTree.init($("#officeTree"), setting1, result.rows);
            } else {
                layer.msg(result.message);
            }
        });
        //已选人员
        ajaxToServer(allotUrl, {}, function (result) {
            if (result.success) {
                var hasList = [];
                $.each(result.userList,function(ind,item){
                    pre_ids.push(item.id);//将已选加入数组
                    hasList.push({
                        id:item.id,
                        name:"<font color='red'>"+item.name+"</font>"
                    });
                });
                selectedTree = $.fn.zTree.init($("#selectedTree"), setting2, hasList);
            } else {
                layer.msg(result.message);
            }
        });
        var setting1 = {view: {selectedMulti:false,nameIsHTML:true,showTitle:false,dblClickExpand:false},
            data: {simpleData: {enable: true}},
            callback: {onClick: treeOnClick}};

        var setting2 = {view: {selectedMulti:false,nameIsHTML:true,showTitle:false,dblClickExpand:false},
            data: {simpleData: {enable: true}},
            callback: {onDblClick: treeOnClick}};
        //点击选择项回调
        function treeOnClick(event, treeId, treeNode, clickFlag){
                $.fn.zTree.getZTreeObj(treeId).expandNode(treeNode);
            if("officeTree"==treeId){
                var data = {
                    deptId:treeNode.id,
                    companyId:treeNode.pId
                };
                data = JSON.stringify(data);
                ajaxToServer('/api/sys/SysUser/selectUser',data, function (result) {
                    if (result.success) {
                        $.fn.zTree.init($("#userTree"), setting2, result.rows);
                    } else {
                        layer.msg(result.message);
                    }

                });
            }
            //待选人员，双击后加入到已选列表
            if("userTree"==treeId){
                var arr= [];
                arr.push(treeNode.id);
                if(checkArr(arr,pre_ids)){
                    layerAlert('请勿重复递交')
                }else{
                    ids.push(String(treeNode.id));
                    selectedTree.addNodes(null, treeNode);
                }

                /*数组重复判断*/
                function  checkArr(arr1,arr2){
                    var rs=false;
                    for (var i=0; i<arr1.length; i++){
                        for (var j=0;j<arr2.length;j++){
                            if( arr1[i]== arr2[j]){
                                rs=true;
                            }
                        }
                    }
                    return rs;
                }


                /*if($.inArray(String(treeNode.id), ids)<0){
                 selectedTree.addNodes(null, treeNode);
                 ids.push(String(treeNode.id));
                 }*/

            };
            //已选择人员，双击后移除
            if("selectedTree"==treeId){

                    if($.inArray(String(treeNode.id), pre_ids)<0){
                        selectedTree.removeNode(treeNode);
                        ids.splice($.inArray(String(treeNode.id), ids), 1);
                    }else{
                        layerAlert("角色原有成员不能清除！", 'info');
                    }
                }

        };
        function clearAssign(){
            var submit = function (v, h, f) {
                if (v == 'ok'){
                    var tips="";
                    if(pre_ids.sort().toString() == ids.sort().toString()){
                        tips = "未给角色【管理员】分配新成员！";
                    }else{
                        tips = "已选人员清除成功！";
                    }
                    ids=pre_ids.slice(0);
                    selectedNodes=pre_selectedNodes;
                    $.fn.zTree.init($("#selectedTree"), setting, selectedNodes);
                    top.$.jBox.tip(tips, 'info');
                } else if (v == 'cancel'){
                    // 取消
                    top.$.jBox.tip("取消清除操作！", 'info');
                }
                return true;
            };
            tips="确定清除角色【管理员】下的已选人员？";
            top.$.jBox.confirm(tips, "清除确认", submit);
        };
        /*    function getSubmitFormId(){
         return "#assignRoleForm";
         };*/

    </script>
</body>
</html>