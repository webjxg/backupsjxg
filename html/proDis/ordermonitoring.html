<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>指令监控</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
</head>
<!--插件样式-->
<link rel="stylesheet" href="../../plugins/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="../../plugins/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="../../plugins/datetimepicker/css/bootstrap-datetimepicker.css">
<link rel="stylesheet" href="../../plugins/datatables/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="../../plugins/icheck/skins/square/green.css">
<link rel="stylesheet" href="../../plugins/datatables/css/mydatatable.css">
<!--引入样式-->
<link rel="stylesheet" href="../../css/common.css">
<link rel="stylesheet" href="../../css/customDataTable.css">
<link rel="stylesheet" href="../../css/aps.css">
<link rel="stylesheet" href="../../css/proDis.css">
<body id="menu-content">
    <div class="wrapper wrapper-content">
        <div class="ibox">
            <div class="ibox-title">
                <h1 class="titName">指令监控</h1>
                <!--<button id="connect" onclick="connect()">连接</button>-->
                <!--<button id="disconnect" onclick="disconnect()">断开</button>-->
                <button id="send" onclick="sendName()">发送</button>
                <hr/>
            </div>
            <div class="ibox-content">
                <div>
                    <ul class="apsType-linkage">
                        <li>

                        </li>
                        <li class="col-1ab394">
                            <i class="fa fa-check-circle"></i>
                            执行完成:<span></span>
                        </li>
                        <li class="wait btn-mainProVal">
                            <i class="fa icon-wait"></i>
                            待执行:<span></span>
                        </li>
                        <li class="stopbn">
                            <i class="fa fa-exclamation-circle"></i>
                            停止执行:<span></span>
                        </li>
                        <li class="btn-cacel">
                            <i class="fa fa-times-circle"></i>
                            取消执行:<span></span>
                        </li>
                    </ul>
                </div>
                <!--创建表格-->
                <table id="treeTable" class="table table-striped table-bordered table-hover table-condensed dataTables-example dataTable tree_table">
                    <thead>
                    <tr>
                        <th>工序</th>
                        <th>指令</th>
                        <th>状态</th>
                        <th>下达时间</th>
                        <th>结束时间</th>
                    </tr>
                    </thead>
                    <tbody id="treeTableBody">
                    </tbody>
                </table>
                <!--分页显示-->
                <div class="clearfix pagination-box">
                    <div class="pagination-detail pull-left" style="display: block;">
                        <div class="page-info pull-left">显示第1到第6条记录，总共 6条记录</div>
                        <div class="page-list pull-left">
                            <span>每页显示</span>
                            <select name="" id="pag-sel">
                                <option value="">请选择</option>
                                <option value="5">5</option>
                                <option value="10" selected="">10</option>
                                <option value="20">20</option>
                                <option value="25">25</option>
                                <option value="30">30</option>
                                <option value="40">40</option>
                                <option value="50">50</option>
                                <option value="-1">all</option>
                            </select>
                            条记录
                        </div>
                    </div>
                    <div id="pagination" class="pagination-roll pull-right"></div>
                </div>
            </div>
        </div>
    </div>

</body>
<!--核心插件-->
<script src="../../js/jquery-2.2.4.min.js"></script>
<script src="../../plugins/bootstrap/js/bootstrap.min.js"></script>
<!--附属插件-->
<script src="../../plugins/layer/layer.js"></script>
<script src="../../plugins/icheck/icheck.min.js"></script>
<script src="../../plugins/ztree/js/jquery.ztree.core.js"></script>
<script src="../../plugins/datatables/js/jquery.dataTables.min.js"></script>
<script src="../../plugins/datatables/js/dataTables.bootstrap.js"></script>
<script src="../../plugins/bootStrapPager/js/extendPagination.js"></script>
<script src="../../plugins/datetimepicker/js/bootstrap-datetimepicker.js"></script>

<!--自定义文件-->
<script src="../../js/common.js"></script>
<script src="../../js/customForm.js"></script>
<script src="../../js/customForm-aps.js"></script>
<script src="../../js/stomp.min.js"></script>
<script src="../../js/sockjs.min.js"></script>
<script src="../../js/page.js"></script>
<script>
    // //页面加载建立连接
    $(function(){
        connect();
        myfunction();
        var date = new Date(),
            getYear = date.getFullYear(),
            getMonth = date.getMonth()+1,
            getDay = date.getDate(),
            getHour = date.getHours(),
            getMiner = date.getMinutes(),
            getSecond = date.getSeconds();
        getMonth = (getMonth<10?"0"+getMonth:getMonth);
        $(".apsType-linkage li").eq(0).text(getYear+"-"+getMonth+"-"+getDay+"         "+getHour+":"+getMiner+":"+getSecond);
    });
    function myfunction(){
        setTimeout(function(){
            sendName();
        },900);
    }
    // webscoket连接方法
    function connect() {
        //var socket = new SockJS('/endpointWisely'); //链接SockJS 的endpoint 名称为"/endpointWisely"
        var socket = new SockJS('http://114.115.165.184:8083/aps-api/endpointWisely'); //链接SockJS 的endpoint 名称为"/endpointWisely"
        stompClient = Stomp.over(socket);//使用stomp子协议的WebSocket 客户端
        stompClient.connect({}, function(frame) {//链接Web Socket的服务端。
            console.log('Connected: ' + frame);
            stompClient.subscribe('/topic/getResponse',function(respnose){ //订阅/topic/getResponse 目标发送的消息。这个是在控制器的@SendTo中定义的。
                showResponse(JSON.parse(respnose.body).responseMessage);
            });
        });
    }
    // 发送消息
    function sendName() {
        //通过stompClient.send 向/welcome 目标 发送消息,这个是在控制器的@messageMapping 中定义的。
        stompClient.send("/welcome", {}, JSON.stringify({ 'name': "" }));
        //stompClient.send("http://localhost:8083/aps-api/websocket/welcome", {}, JSON.stringify({ 'name': name }));
    }
        // 接收返回信息
    function showResponse(message) {
        var statusarr = [];
        var statusarr1 = [];
        var statusarr2 = [];
        var statusarr3 = [];
        for(var i=0;i<message.rows.length;i++){
            if(message.rows[i].status == 0){
                statusarr.push(message.rows[i].status);
            }else if(message.rows[i].status == 1){
                statusarr1.push(message.rows[i].status);
            }else if(message.rows[i].status == 2){
                statusarr2.push(message.rows[i].status);
            }else if(message.rows[i].status == -1){
                statusarr3.push(message.rows[i].status);
            }
        }
        $(".wait span").text(statusarr.length);
        $(".col-1ab394 span").text(statusarr1.length);
        $(".stopbn span").text(statusarr2.length);
        $(".btn-cacel span").text(statusarr3.length)
        createTable(message.rows)
    }
    //创建table
    function createTable(data){
        //  datatables使用ajax
        console.log(data)
        $('#treeTable').dataTable({
            "bPaginate": false,
            "bAutoWidth": false,
            "bDestroy": true,
            "paging": false,
            "bProcessing": true,
            "searching": false, //禁用aa原生搜索
            "info": false,  //底部文字
            "order": [],
            "ordering": false,
            "oLanguage": lang,
            "data": data,
            //定义列 宽度 以及在json中的列名
            "aoColumns": [
                {"data": "proc", 'sClass': " alignCenter authName","width":'20%'},
                {"data": "content", 'sClass': "alignCenter autoWidth","width":'20%'},
                {"data": "",'order':false,"defaultContent": "", 'sClass': "alignCenter",
                    "render":function (data,type,row,meta) {
                        var html = "";
                        if (row.status == "1") {
                            var setText = "执行完成";
                            html = "<span class='btn-primary1'><i class='fa fa-check-circle'></i>"+setText+"</span>";
                        } else if (row.status == "2") {
                            setText = "停止执行";
                            html = "<span class='btn-stop'><i class='fa fa-exclamation-circle'></i>"+setText+"</span>";
                        } else if (row.status == "-1") {
                            setText = "取消执行";
                            html ="<span class='btn-cancel'><i class='fa fa-times-circle'></i>"+setText+"</span>";
                        } else if (row.status == "0") {
                            setText = "待执行";
                            html = "<span class='btn-await1 btn-mainProVal'><i class='fa icon-wait'></i>"+setText+"</span>";
                        }
                        return html;
                    }
                },
                {"data": "issuedTime", 'sClass': "alignCenter"},
                {"data": "updateDate", 'sClass': "alignCenter"}
            ]
        });
        RenderiCheckTblBody();
    }

</script>

</html>