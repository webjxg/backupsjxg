<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>计划模版</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <!--插件样式-->
    <link rel="stylesheet" href="../../plugins/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../plugins/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../plugins/easyui/themes/default/easyui.css">
    <link rel="stylesheet" href="../../plugins/easyui/themes/default/datagrid.css">
    <!--引入样式-->
    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="../../css/aps.css">
    <!--<link rel="stylesheet" href="../../css/dictionaries.css">-->
    <style>
        .row {
            margin-bottom: 20px;
        }

        .pull-left {
            font-size: 0;
        }

        .pull-left span {
            margin: 10px 0;
            font-size: 16px;
            font-weight: 100;
        }

        .pull-left select {
            width: 100px;
            height: 30px;
            line-height: 30px;
            font-size: 16px;
            border-radius: 5px;
            border-color: #acbad5;
            padding: 0 5px 0 5px;
            /*margin-left: 15px;*/
        }

        .panel-group {
            width: 100%;
        }

        .panel-group .panel + .panel {
            margin-top: 15px;
        }

        .panel-heading {
            padding: 10px 25px;
        }

        .panel-heading > span {
            color: white;
        }

        tr th {
            text-align: center;
        }

        tr td input {
            width: 80%;
            height: 100%;
            line-height: 100%;
            border: 1px solid #e5e6e7;
            border-radius: 2px;
        }
    </style>
    <script>var urlPrefix = "http://114.115.165.184:8083/aps-api";</script>


</head>
<body>
<div class="wrapper wrapper-content ibox-content">
    <!--按钮条-->
    <div class="row">
        <div class="col-sm-12">
            <div class="pull-left">
                <input type="text" hidden="hidden" name="id" id="id">
                <span>请选择部门:</span>
                <select name="dept" id="dept">
                <option value="采购部">采购部</option>
                <option value="产品部">产品部</option>
                <option value="环卫部">环卫部</option>
                <option value="运行部">运行部</option>
                </select>
                <!--下拉菜单选择时间-->
                <span>日期:</span>
                <select name="dpYear" id="dpYear">
                    <option value="2018">2018</option>
                    <option value="2019">2019</option>
                    <option value="2020">2020</option>
                    <option value="2021">2021</option>
                    <option value="2022">2022</option>
                    <option value="2023">2023</option>
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                </select>
                <span>年</span>
                <select name="dpMonth" id="dpMonth">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                </select>
                <span>月</span>
                <span>第</span>
                <select name="dpWeek" id="dpWeek">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
                <span>周生产计划</span>
            </div>
            <div class="pull-right">
                <input type="hidden" name="state" id="state" value>
                <button class="btn btn-primary bg-ffa82d  btn-submit" id="submit-btn"><i
                        class="fa fa-check-square-o"></i> 递交
                </button>
                <button class="btn btn-primary bg-ffa82d btn-save" id="save-btn"><i
                        class="fa fa-save"></i> 暂存
                </button>
            </div>
        </div>
    </div>
    <!--表格区-->
    <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
        <!--班计划-->
        <div class="panel panel-default ">
            <div class="panel-heading" style="font-size: 20px;background-color: #1AB394;"
                 onclick="$('div.datagrid:eq(0)').toggle(500)">
                <span>班计划</span>
                <a style="font-size: 25px; color:white; float: right;">
                    <i class="fa fa-navicon"></i>
                </a>
            </div>
            <div class="tableItemBox">
                <table id="td0"
                       class="table-striped table-bordered table-hover table-condensed dataTables-example dataTable tableItem">
                </table>
            </div>
        </div>
        <!--产量-->
        <div class="panel panel-default">
            <div class="panel-heading" onclick="$('div.datagrid:eq(1)').toggle(500)" role="tablist"
                 aria-multiselectable="true" style="font-size: 20px;background-color: #1AB394;">
                <span>产量计划</span>
                <a style="font-size: 25px; color:white; float: right;">
                    <i class="fa fa-navicon"></i>
                </a>
            </div>
            <div class="tableItemBox">
                <table id="td1"
                       class="table-striped table-bordered table-hover table-condensed dataTables-example dataTable tableItem ">
                </table>
            </div>
        </div>

        <!--质量指标计划-->
        <div class="panel panel-default">
            <div class="panel-heading" style="font-size: 20px;background-color: #1AB394;"
                 onclick="$('div.datagrid:eq(2)').toggle(500)">
                <span>质量指标计划</span>
                <a style="font-size: 25px; color:white; float: right;">
                    <i class="fa fa-navicon"></i>
                </a>
            </div>
            <div class="tableItemBox">
                <table id="td2"
                       class="table-striped table-bordered table-hover table-condensed dataTables-example dataTable">
                </table>
            </div>
        </div>
        <!--技术指标计划-->
        <div class="panel panel-default">
            <div class="panel-heading" style="font-size: 20px;background-color: #1AB394;"
                 onclick="$('div.datagrid:eq(3)').toggle(500)">
                <span>技术指标计划</span>
                <a style="font-size: 25px; color:white; float: right;">
                    <i class="fa fa-navicon"></i>
                </a>
            </div>
            <div class="tableItemBox">
                <table id="td3"
                       class="table-striped table-bordered table-hover table-condensed dataTables-example dataTable">
                </table>
            </div>
        </div>
        <!--各项单耗指标计划-->
        <div class="panel panel-default">
            <div class="panel-heading" style="font-size: 20px;background-color: #1AB394;"
                 onclick="$('div.datagrid:eq(4)').toggle(500)">
                <span>各项单耗指标计划</span>
                <a style="font-size: 25px; color:white; float: right;">
                    <i class="fa fa-navicon"></i>
                </a>
            </div>
            <div class="tableItemBox">
                <table id="td4"
                       class="table-striped table-bordered table-hover table-condensed dataTables-example dataTable">
                </table>
            </div>
        </div>
    </div>
</div>
<!--核心插件-->
<script src="../../js/jquery-2.2.4.min.js"></script>
<script src="../../plugins/bootstrap/js/bootstrap.min.js"></script>
<!--附属插件-->
<script src="../../plugins/layer/layer.js"></script>
<script src="../../plugins/easyui/js/jquery.easyui.min.js"></script>
<script src="../../js/dataGridCustom.js"></script>
<script src="../../js/customForm-aps.js"></script>


</body>
<script>
    $(function () {
        tabledatagrid();
        onchangereload('#dept');
        onchangereload('#dpYear');
        onchangereload('#dpMonth');
        onchangereload('#dpWeek');


        $('#td0,#td1,#td2,#td3,#td4').datagrid('hideColumn', 'id');
        $(".btn-save").click(function () {
            btnSubSave(0);
        });
        $(".btn-submit").click(function () {
            btnSubSave(1);
        });
    });


    //多表格请求数据渲染方法
    function tabledatagrid() {
        //建立空数组
        var cljh = [],
            bjh = [],
            zlzbjh = [],
            jszbjh = [],
            gxdhzbjh = []; //请求数据渲染表格 以及实现datagrid部分功能

        var dept = $('#dept').val(),
            dpYear = $('#dpYear').val(),
            dpMonth = $('#dpMonth').val(),
            dpWeek = $('#dpWeek').val();

        var data0 = {
            "dept": dept,
            "dpYear": dpYear,
            "dpMonth": dpMonth,
            "dpWeek": dpWeek
        };
        var da = JSON.stringify(data0);
        $.ajax({
            headers: {
                Accept: "application/json; charset=utf-8",
                Authorization: "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJhZG1pbiIsImlzcyI6ImFkbWluIiwiYXVkIjoiQWRtaW4gSldUIE9ubGluZSJ9.0fEB0SHaUfc10ARex-BCLPmOxbbr5vgcMfvivQKY1Rc"
            },
            type: "post",
            dataType: 'json',
            data: da,
            contentType: 'application/json',
            url: urlPrefix + "/api/aps/DayPlan/form",
            success: function (result) {
                console.log(da,result);
                var bjh = result.bjh,
                    cljh = result.cljh,
                    zlzbjh = result.zlzbjh,
                    gxdhzbjh = result.gxdhzbjh,
                    jszbjh = result.jszbjh;
                //班计划
                for (var item in bjh) {
                    var arrItem = {
                        'id': bjh[item].id,
                        'itemName': bjh[item].itemName,
                        'itemUnit': bjh[item].itemUnit,
                        'weekPlan': bjh[item].weekPlan,
                        'dayPlan': bjh[item].dayPlan,
                        'classPlan': bjh[item].classPlan
                    };
                    bjh.push(arrItem);
                }
                //产量计划
                for (var item in cljh) {
                    var arrItem = {
                        'id': cljh[item].id,
                        'itemName': cljh[item].itemName,
                        'itemUnit': cljh[item].itemUnit,
                        'monthPlan': cljh[item].monthPlan,
                        'weekPlan': cljh[item].weekPlan,
                        'dayPlan': cljh[item].dayPlan
                    };
                    cljh.push(arrItem);
                }
                //质量指标计划
                for (var item in zlzbjh) {
                    var arrItem = {
                        'id': zlzbjh[item].id,
                        'pName': zlzbjh[item].pName,
                        'itemName': zlzbjh[item].itemName,
                        'itemUnit': zlzbjh[item].itemUnit,
                        'weekPlan': zlzbjh[item].weekPlan,
                        'dayPlan': zlzbjh[item].dayPlan,
                        'classPlan': zlzbjh[item].classPlan
                    };
                    zlzbjh.push(arrItem);
                }
                //技术指标计划
                for (var item in jszbjh) {
                    var arrItem = {
                        'id': jszbjh[item].id,
                        'itemName': jszbjh[item].itemName,
                        'itemUnit': jszbjh[item].itemUnit,
                        'monthPlan': jszbjh[item].monthPlan,
                        'weekPlan': jszbjh[item].weekPlan,
                        'dayPlan': jszbjh[item].dayPlan
                    };
                    jszbjh.push(arrItem);
                }
                //各项单耗指标计划
                for (var item in gxdhzbjh) {
                    var arrItem = {
                        'id': gxdhzbjh[item].id,
                        'itemName': gxdhzbjh[item].itemName,
                        'itemUnit': gxdhzbjh[item].itemUnit,
                        'monthPlan': gxdhzbjh[item].monthPlan,
                        'weekPlan': gxdhzbjh[item].weekPlan,
                        'dayPlan': gxdhzbjh[item].dayPlan
                    };
                    gxdhzbjh.push(arrItem);
                }
                $('#td0').datagrid('loadData', bjh);
                $('#td1').datagrid('loadData', cljh);
                $('#td2').datagrid('loadData', zlzbjh);
                $('#td3').datagrid('loadData', jszbjh);
                $('#td4').datagrid('loadData', gxdhzbjh);
            }

        });

        //班计划
        $('#td0').datagrid({
            fitColumns: true,
            rownumbers: true,
            collapsible: true,
            singleSelect: true,
            onClickRow: function (index) {
                dataGridObj.startEditing(index, "#td0")
            },
            columns: [[
                {field: 'id', title: 'id', hideColumn: 'id'},
                {field: 'itemName', title: '项目', width: 100, align: 'center'},
                {field: 'itemUnit', title: '单位', width: 100, align: 'center'},
                {
                    field: 'weekPlan',
                    title: '周计划',
                    width: 100,
                    align: 'center',
                    editor: {type: 'numberbox', options: {precision: 1}}
                },
                {field: 'dayPlan', title: '日计划', editor: 'numberbox', width: 100, align: 'center'},
                {field: 'classPlan', title: '班计划', editor: 'text', width: 150, align: 'center'}
            ]],
            onAfterEdit: function (rowIndex, rowData, changes) {
                dataGridObj.pushRowData(rowData);
                dataGridObj.setEditIndex("#td0", undefined);
            }
        });
        //产量计划
        $('#td1').datagrid({
            fitColumns: true,
            rownumbers: true,
            collapsible: true,
            singleSelect: true,
            onClickRow: function (index) {
                dataGridObj.startEditing(index, "#td1")
            },
            columns: [[
                {field: 'id', title: 'id', hideColumn: 'id'},
                {field: 'itemName', title: '项目', width: 100, align: 'center'},
                {field: 'itemUnit', title: '单位', width: 100, align: 'center'},
                {
                    field: 'mouthPlan',
                    title: '月计划',
                    width: 100,
                    align: 'center',
                    editor: {type: 'numberbox', options: {precision: 1}}
                },
                {field: 'weekPlan', title: '周计划', editor: 'numberbox', width: 100, align: 'center'},
                {field: 'dayPlan', title: '日计划', editor: 'text', width: 150, align: 'center'},
            ]],
            onAfterEdit: function (rowIndex, rowData, changes) {
                dataGridObj.pushRowData(rowData);
                dataGridObj.setEditIndex("#td1", undefined);
            }
        });
        //质量指标计划
        $('#td2').datagrid({
            fitColumns: true,
            rownumbers: true,
            collapsible: true,
            singleSelect: true,
            onClickRow: function (index) {
                dataGridObj.startEditing(index, "#td2")
            },
            columns: [[
                {field: 'id', title: 'id', hideColumn: 'id'},
                {field: 'pName', title: '名称', width: 100, align: 'center'},
                {field: 'itemName', title: '项目', width: 100, align: 'center'},
                {field: 'itemUnit', title: '单位', width: 100, align: 'center'},
                {
                    field: 'weekPlan',
                    title: '周计划',
                    width: 100,
                    align: 'center',
                    editor: {type: 'numberbox', options: {precision: 1}}
                },
                {field: 'dayPlan', title: '日计划', editor: 'numberbox', width: 100, align: 'center'},
                {field: 'classPlan', title: '班计划', editor: 'text', width: 150, align: 'center'},
            ]],
            onAfterEdit: function (rowIndex, rowData, changes) {
                dataGridObj.pushRowData(rowData);
                dataGridObj.setEditIndex("#td2", undefined);
            }
        });
//技术指标计划
        $('#td3').datagrid({
            fitColumns: true,
            rownumbers: true,
            collapsible: true,
            singleSelect: true,
            onClickRow: function (index) {
                dataGridObj.startEditing(index, "#td3")
            },
            columns: [[
                {field: 'id', title: 'id', hideColumn: 'id'},
                {field: 'itemName', title: '项目', width: 100, align: 'center'},
                {field: 'itemUnit', title: '单位', width: 100, align: 'center'},
                {
                    field: 'mouthPlan',
                    title: '月计划',
                    width: 100,
                    align: 'center',
                    editor: {type: 'numberbox', options: {precision: 1}}
                },
                {field: 'weekPlan', title: '周计划', editor: 'numberbox', width: 100, align: 'center'},
                {field: 'dayPlan', title: '日计划', editor: 'text', width: 150, align: 'center'},
            ]],
            onAfterEdit: function (rowIndex, rowData, changes) {
                dataGridObj.pushRowData(rowData);
                dataGridObj.setEditIndex("#td3", undefined);
            }
        });
//各项单耗指标计划
        $('#td4').datagrid({
            fitColumns: true,
            rownumbers: true,
            collapsible: true,
            singleSelect: true,
            onClickRow: function (index) {
                dataGridObj.startEditing(index, "#td4")
            },
            columns: [[
                {field: 'id', title: 'id', hideColumn: 'id'},
                {field: 'itemName', title: '项目', width: 100, align: 'center'},
                {field: 'itemUnit', title: '单位', width: 100, align: 'center'},
                {
                    field: 'mouthPlan',
                    title: '月计划',
                    width: 100,
                    align: 'center',
                    editor: {type: 'numberbox', options: {precision: 1}}
                },
                {field: 'weekPlan', title: '周计划', editor: 'numberbox', width: 100, align: 'center'},
                {field: 'dayPlan', title: '日计划', editor: 'text', width: 150, align: 'center'},
            ]],
            onAfterEdit: function (rowIndex, rowData, changes) {
                dataGridObj.pushRowData(rowData);
                dataGridObj.setEditIndex("#td4", undefined);
            }
        });
    }

<<<<<<< .mine
    //表头按钮变更重新渲染表格方法
    function onchangereload(dp){
        $(dp).change(function () {
            tabledatagrid()
            $('#td0,#td1,#td2,#td3,#td4').datagrid('hideColumn', 'id');
        });
=======
});
    var editIndex = undefined;
    $('#yieldTable').datagrid({
    fitColumns:true,
    rownumbers:true,
    collapsible:true,
    singleSelect: true,
    onClickRow: function(index){
        a(index,"#yieldTable")
    },
    columns:[[
        {field:'id',title:'id', hideColumn:'id'},
        {field:'itemName',title:'项目',width:100,align:'center'},
        {field:'itemUnit',title:'单位',width:100,align:'center'},
        {field:'yearTarget',title:'全年基本目标',width:100,align:'center',editor:{type:'numberbox',options:{precision:1}}},
        {field:'monthPlan',title:'月计划',editor:'numberbox',width:100,align:'center'},
        {field:'remark',title:'备注',editor:'text',width:150,align:'center'},
    ]],
    onAfterEdit: function (rowIndex, rowData, changes) {
        pushRowData(rowData);
        editIndex = undefined;
        editRow = undefined;
    },
    toolbar: '#tb',
});
$('#shiftlan').datagrid({
    fitColumns:true,
    rownumbers:true,
    collapsible:true,
    singleSelect: true,
    onClickRow: function(index){
        a(index,"#shiftlan")
    },
    columns:[[
        {field:'id',title:'id', hideColumn:'id'},
        {field:'itemName',title:'项目',width:100,align:'center'},
        {field:'itemName1',title:'项目1',width:100,align:'center'},
        {field:'itemUnit',title:'单位',width:100,align:'center'},
        {field:'yearTarget',title:'全年基本目标',width:100,align:'center',editor:{type:'numberbox',options:{precision:1}}},
        {field:'monthPlan',title:'月计划',editor:'numberbox',width:100,align:'center'},
        {field:'remark',title:'备注',editor:'text',width:150,align:'center'},
    ]],
    onAfterEdit: function (rowIndex, rowData, changes) {
        pushRowData(rowData);
        editIndex = undefined;
        editRow = undefined;
    },
    toolbar: '#tb1',
});
$('#qualityIndex').datagrid({
    fitColumns:true,
    rownumbers:true,
    collapsible:true,
    singleSelect: true,
    onClickRow: function(index){
        a(index,"#qualityIndex")
    },
    columns:[[
        {field:'id',title:'id', hideColumn:'id'},
        {field:'itemName',title:'项目',width:100,align:'center'},
        {field:'itemUnit',title:'单位',width:100,align:'center'},
        {field:'yearTarget',title:'全年基本目标',width:100,align:'center',editor:{type:'numberbox',options:{precision:1}}},
        {field:'monthPlan',title:'月计划',editor:'numberbox',width:100,align:'center'},
        {field:'remark',title:'备注',editor:'text',width:150,align:'center'},
    ]],
    onAfterEdit: function (rowIndex, rowData, changes) {
        pushRowData(rowData);
        editIndex = undefined;
        editRow = undefined;
    },
    toolbar: '#tb2',
});
$('#technicalIndex').datagrid({
    fitColumns:true,
    rownumbers:true,
    collapsible:true,
    singleSelect: true,
    onClickRow: function(index){
        a(index,"#technicalIndex")
    },
    columns:[[
        {field:'id',title:'id', hideColumn:'id'},
        {field:'itemName',title:'项目',width:100,align:'center'},
        {field:'itemUnit',title:'单位',width:100,align:'center'},
        {field:'yearTarget',title:'全年基本目标',width:100,align:'center',editor:{type:'numberbox',options:{precision:1}}},
        {field:'monthPlan',title:'月计划',editor:'numberbox',width:100,align:'center'},
        {field:'remark',title:'备注',editor:'text',width:150,align:'center'},
    ]],
    onAfterEdit: function (rowIndex, rowData, changes) {
        pushRowData(rowData);
        editIndex = undefined;
        editRow = undefined;
    },
    toolbar: '#tb3',
});
$('#consumption').datagrid({
    fitColumns:true,
    rownumbers:true,
    collapsible:true,
    singleSelect: true,
    onClickRow: function(index){
        a(index,"#consumption")
    },
    columns:[[
        {field:'id',title:'id', hideColumn:'id'},
        {field:'itemName',title:'项目',width:100,align:'center'},
        {field:'itemUnit',title:'单位',width:100,align:'center'},
        {field:'yearTarget',title:'全年基本目标',width:100,align:'center',editor:{type:'numberbox',options:{precision:1}}},
        {field:'monthPlan',title:'月计划',editor:'numberbox',width:100,align:'center'},
        {field:'remark',title:'备注',editor:'text',width:150,align:'center'},
    ]],
    onAfterEdit: function (rowIndex, rowData, changes) {
        pushRowData(rowData);
        editIndex = undefined;
        editRow = undefined;
    },
    toolbar: '#tb4',
});
//编辑过的元素如果不存在就push到数组中，如果已存在新的数据会替换原有的数据
function pushRowData(rowData){
    if(saveItemArr.length>0){
        filterItem(saveItemArr,rowData);
        if(arrIndex == -1){
            saveItemArr.push(rowData);
        }else{
            saveItemArr.splice(arrIndex,1,rowData);
>>>>>>> .r294

    }

    //暂存递交
    function btnSubSave(status) {
        var len = $(".tableItemBox").length;
        for (var i = 0; i < len; i++) {
            $("#td" + i).parents('.datagrid-view').siblings(".datagrid-toolbar").find(".l-btn-text").trigger('click');
        }
        var id = '', status = status, dayPlanId = '', mouthPlan = '', weekPlan = '', dayPlan = '', classPlan = ''
        var editItems = dataGridObj.saveItemArr;
        console.log(editItems);
        for (var i = 0; i < editItems.length; i++) {
            id += "," + editItems[i].id;
            dayPlanId += "," + editItems[i].template.id;
            mouthPlan += "," + editItems[i].mouthPlan;
            weekPlan += "," + editItems[i].weekPlan;
            dayPlan += "," + editItems[i].dayPlan;
            classPlan += "," + editItems[i].classPlan;
        }
        if (id.length > 0) {
            var data = {
                "id": id.substr(1),
                "statu": status,
                "dayPlanId": dayPlanId.substr(1),
                "mouthPlan": mouthPlan.substr(1),
                "weekPlan": weekPlan.substr(1),
                "dayPlan": dayPlan.substr(1),
                "classPlan": classPlan.substr(1),
            };

            ajaxToServer1('/api/aps/DayPlan/save', data, layermsg);
            function layermsg(msg) {
                console.log(msg);
                if (msg.success) {
                    layer.msg('提交成功')
                } else {
                    layer.msg(msg.massage)
                }
            }
            console.log(data);
        } else {
            top.layer.alert('请填写信息后再保存，目前无任何信息', {icon: 0, title: '警告'});
        }
    }



</script>

</html>