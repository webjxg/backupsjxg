<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" content="width=device-width,initial-scale=1.0">
    <title>Title</title>
    <!--插件样式-->
    <link rel="stylesheet" href="../../plugins/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../plugins/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../plugins/easyui/themes/default/easyui.css">
    <link rel="stylesheet" href="../../plugins/easyui/themes/default/datagrid.css">
    <link rel="stylesheet" href="../../plugins/datetimepicker/css/bootstrap-datetimepicker.css">
    <!--引入样式-->
    <link rel="stylesheet" href="../../css/customDatagrid.css">
    <link rel="stylesheet" href="../../css/aps.css">
    <link rel="stylesheet" href="../../css/common.css">
</head>

<body>
<div  class="wrapper wrapper-content ibox-content">
    <div class="ibox">
        <div class="ibox-content">
            <div class="row" style="margin-bottom: 15px">
                <div class="col-lg-12">
                    <div>
                        <h1 class="titName">复晟铝业<span class="year"></span>年生产经营计划</h1>
                    </div>
                    <div class="clearfix btn-box">
                        <div class="pull-left">
                            <ul class="apsType-linkage">
                                <li class="month">
                                    计划周期（年）：
                                    <input type="text" value="" id="yMPicker" class="time-input form-control datePicker" placeholder="请选择年份">
                                </li>
                            </ul>
                        </div>
                        <div class="pull-right">
                            <button class="btn btn-back btn-white" id="back-btn">
                                <i class="fa fa-reply"></i> 返回
                            </button>
                            <button class="btn btn-save  btn-bgf29">
                                <i class="fa fa-save"></i>
                                保存</button>
                            <button class="btn btn-white btn-sub"><i class="fa fa-upload"></i>提交</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tableItemBox" >
                <table id="td0"  class="tableItem" title="年计划"></table>
            </div>
        </div>
    </div>
</div>
<!--表格区-->
</body>
<script src="../../js/jquery-2.2.4.min.js"></script>
<script src="../../plugins/bootstrap/js/bootstrap.min.js"></script>
<!--附属插件-->
<script src="../../plugins/layer/layer.js"></script>
<script src="../../plugins/datetimepicker/js/bootstrap-datetimepicker.js"></script>
<script src="../../plugins/datatables/js/jquery.dataTables.min.js"></script>
<script src="../../plugins/datatables/js/dataTables.bootstrap.js"></script>
<script src="../../plugins/bootStrapPager/js/extendPagination.js"></script>
<script src="../../plugins/easyui/js/jquery.easyui.min.js"></script>
<script src="../../js/dataGridCustom.js"></script>
<script src="../../js/customForm-aps.js"></script>

<script>
    var planarr = [];
    var arr  =[];
    var mainID;
    var id = getQueryString('id');
    var year = getQueryString('year');
    $("#yMPicker").val(year);
    var $yesteryear;
    var $thisyear;
    $(function () {
        var data = {

        };
        var date = new Date();
        getYear = date.getFullYear();
        $(".year").text(getYear)
        $("#yMPicker").datetimepicker({
            format:"yyyy",
            language:'cn',
            weekStart: 1,
            pickTime: false,
            autoclose:true,
            startView: 4, //月视图
            minView: "4",
            forceParse: 0
        });
        ajaxToServer("/api/aps/ApsYearPlan/queryYearPlan",JSON.stringify(data),function (result) {
            mainID = result.cpxl[0].mainId
            planarr.push(result.cpxl);
            planarr.push(result.zyxhzbjh);
            createTbody(planarr);
        })
        //返回按钮
        var check=getQueryString('check');
        if(check==0){
            $('#back-btn').hide();
            $('.btn-save').hide();
        }
        $(".btn-back").click(function () {
            refreshActiveTab();
        });
        // 是否确认保存按钮
        clickHandler()
    });
    function clickHandler() {
        $(".btn-save").click(function (e) {
            if($("#yMPicker").val() == ""){
                layer.confirm("请选择具体年份之后才可以保存!");
            }else{
                var e = "btn-save"
                preserveFn(e)
            }
        });
        $(".btn-sub").click(function (e) {
            if($("#yMPicker").val() == ""){
                layer.confirm("请选择具体年份之后才可以提交!");
            }else{
                var e = "btn-sub"
                preserveFn(e)
            }
        })
    }
    // 是否保存、提交
    function preserveFn(e) {
        if(e == "btn-save"){
            var status = "0";
            layer.confirm("确认保存！")
        }else{
            var status = "1";
            layer.confirm("确认提交！")
        }
        var status = status
        var editItems = dataGridObj.getSaveItemArr();
        var data = {
            "yearPlans":JSON.stringify(editItems),
            "status":status,
            "adYear":$("#yMPicker").val(),
            "mainId":mainID
        }
        $(".layui-layer-btn0").click(function () {
            sendmsg(data)
        });
    }
    // 保存信息
    function sendmsg(data) {
        ajaxToServer1("/aps/ApsYearPlan/saveYearInfo",data,function (result) {

        })

    }
    // 创建表格
    function createTbody(planarr) {
        for(var i=0;i<planarr.length;i++){
            for(var j=0;j<planarr[i].length;j++){
                msgobj = {
                    "id":planarr[i][j].id,
                    "groupName":planarr[i][j].groupName,
                    "itemName":planarr[i][j].itemName,
                    "itemUnit":planarr[i][j].itemUnit,
                    "adYear":planarr[i][j].adYear,
                    "adMonth":planarr[i][j].adMonth,
                    "ndyjcl":planarr[i][j].ndyjcl,
                    "yjdsjdcl":planarr[i][j].yjdsjdcl,
                    "ncl":planarr[i][j].ncl,
                    "templetId":planarr[i][j].templetId,
                    "mainId":planarr[i][j].mainId
                };
                arr.push(msgobj)
            }
            $('#td0').datagrid('loadData',arr);
        }
    };
    if(year == null){
        $yesteryear = "去";
        $thisyear = "今"
    }else{
        $yesteryear = year - 1;
        $thisyear = year;

    }
    $("#td0").datagrid({
        fitColumns:true,
        collapsible:true,
        singleSelect: true,
        onClickRow: function(index){
            dataGridObj.startEditing(index,"#td0")
        },
        //创建table
        columns:[[
            {field:'id',title:'id',hideColumn:'id'},
            {field:'mainId',title:'mainId',hideColumn:'mainId'},
            {field:'groupName',title:'生产计划',width:100,align:'center'},
            {field:'itemName',title:'项目',width:100,align:'center'},
            {field:'itemUnit',title:'单位',width:100,align:'center'},
            {field:'ndyjcl',title:$yesteryear+'年预计产量',editor:'numberbox',width:100,align:'center'},
            {field:'yjdsjdcl',title:'预计第四季度产量',editor:'numberbox',width:100,align:'center'},
            {field:'ncl',title:$thisyear+'年产量',editor:'numberbox',width:100,align:'center'}
        ]],
        onAfterEdit: function (rowIndex, rowData, changes) {
            dataGridObj.pushRowData(rowData);
            dataGridObj.setEditIndex("#td0",undefined);
            dataGridObj.mergeCells(loadedData,"#td0","groupName");
        },
        //合并单元格
        onLoadSuccess:function (data) {
            loadedData = data;
            dataGridObj.mergeCells(data,"#td0","groupName");
        },
        toolbar: [{
            text: '保存', iconCls: 'icon-save', handler: function () {
                //保存时结束当前编辑的行，自动触发onAfterEdit事件如果要与后台交互可将数据通过Ajax提交后台
                $('#td0').datagrid('endEdit', dataGridObj.getEditIndex("#td0"));
            }
        }]
    })
    //隐藏id列
    $(function(){
        $('#td0').datagrid('hideColumn','id');
        $('#td0').datagrid('hideColumn','mainId');
    });
    //输入框change事件
    $("#yMPicker").change(function () {
        var data = {
            adYear:$("#yMPicker").val()
        }
        ajaxToServer("/api/aps/ApsYearPlan/form",JSON.stringify(data),function (result) {
            if(result.success==true){
               if(result.rows.length>0){
                   layer.confirm("选择的年份已经存在，请重新选择!");
                   $("#yMPicker").val("请选择年份")
               }
            }
        })
        var $yearupdata =$("#yMPicker").val();
        $yesteryear = $yearupdata - 1;
        $thisyear = $yearupdata;
        $("#td0").datagrid({
            fitColumns:true,
            collapsible:true,
            singleSelect: true,
            onClickRow: function(index){
                dataGridObj.startEditing(index,"#td0")
            },
            //创建table
            columns:[[
                {field:'id',title:'id',hideColumn:'id'},
                {field:'mainId',title:'mainId',hideColumn:'mainId'},
                {field:'groupName',title:'生产计划',width:100,align:'center'},
                {field:'itemName',title:'项目',width:100,align:'center'},
                {field:'itemUnit',title:'单位',width:100,align:'center'},
                {field:'ndyjcl',title:$yesteryear+'年预计产量',editor:'numberbox',width:100,align:'center'},
                {field:'yjdsjdcl',title:'预计第四季度产量',editor:'numberbox',width:100,align:'center'},
                {field:'ncl',title:$thisyear+'年产量',editor:'numberbox',width:100,align:'center'}
            ]],
            onAfterEdit: function (rowIndex, rowData, changes) {
                dataGridObj.pushRowData(rowData);
                dataGridObj.setEditIndex("#td0",undefined);
                dataGridObj.mergeCells(loadedData,"#td0","groupName");
            },
            //合并单元格
            onLoadSuccess:function (data) {
                loadedData = data;
                dataGridObj.mergeCells(data,"#td0","groupName");
            },
            toolbar: [{
                text: '保存', iconCls: 'icon-save', handler: function () {
                    //保存时结束当前编辑的行，自动触发onAfterEdit事件如果要与后台交互可将数据通过Ajax提交后台
                    $('#td0').datagrid('endEdit', dataGridObj.getEditIndex("#td0"));
                }
            }]
        })
        //隐藏id列
        $(function(){
            $('#td0').datagrid('hideColumn','id');
            $('#td0').datagrid('hideColumn','mainId');
        });
    })
</script>
</html>